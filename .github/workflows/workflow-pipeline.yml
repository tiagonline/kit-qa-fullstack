name: workflow-pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ==================================================================
  # PARTE 1: RODAR TESTES (TUDO EM PARALELO)
  # ==================================================================

  # 1. API TESTS
  api-tests:
    name: âš¡ API Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18, cache: 'npm' }
      - run: npm ci
      - run: npx playwright install --with-deps
      
      - name: Run API Tests
        run: npm run test:api
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}

      # Apenas salva o arquivo, nÃ£o publica ainda
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-report
          path: playwright-report/
          retention-days: 1

  # 2. E2E TESTS (Sem publicar pages aqui)
  e2e-tests:
    name: ðŸ–¥ï¸ E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v3 # NecessÃ¡rio para gerar Allure depois
        with: { distribution: 'temurin', java-version: '17' }
      - uses: actions/setup-node@v4
        with: { node-version: 18, cache: 'npm' }
      - run: npm ci
      - run: npx playwright install --with-deps chromium
      
      - name: Run E2E Tests
        run: npm run test:e2e
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
          SAUCE_PASSWORD: ${{ secrets.SAUCE_PASSWORD }}
      
      # Salva os resultados "crus" do Allure para gerar o HTML depois
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results
          path: allure-results/
          retention-days: 1

  # 3. MOBILE TESTS
  mobile-tests:
    name: ðŸ“± Mobile Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18, cache: 'npm' }
      - run: npm ci
      - run: npx playwright install --with-deps
      
      - name: Run Mobile Tests
        run: npx playwright test tests/mobile --project='Mobile Chrome'
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mobile-report
          path: playwright-report/
          retention-days: 1

  # 4. LOAD TESTS
  load-tests:
    name: ðŸš€ K6 Load
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18 }
      - run: npm ci
      - uses: grafana/setup-k6-action@v1
      
      - name: Run Load Tests
        run: |
          docker compose -f tests/k6-load/docker-compose.yml up -d influxdb grafana
          sleep 15
          npm run k6:ci
          docker compose -f tests/k6-load/docker-compose.yml down
        env:
          K6_BASE_URL: ${{ secrets.K6_BASE_URL }}

      - name: Move Report
        if: always()
        run: |
          mkdir -p k6-temp
          mv tests/k6-load/dist/report.html k6-temp/index.html || mv report.html k6-temp/index.html

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-report
          path: k6-temp/
          retention-days: 1

  # ==================================================================
  # PARTE 2: DEPLOY ÃšNICO (GERENTE DE RELATÃ“RIOS)
  # ==================================================================
  report-deploy:
    name: ðŸ“Š Publish Reports
    if: always() # Roda mesmo se testes falharem
    needs: [api-tests, e2e-tests, mobile-tests, load-tests] # Espera todo mundo
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Recupera o histÃ³rico antigo do Allure (para manter grÃ¡ficos de tendÃªncia)
      - name: Get Allure history
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages-history

      # 2. Baixa TODOS os artefatos gerados pelos testes
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      # 3. Gera o RelatÃ³rio Allure Final (transforma JSON em HTML)
      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: artifacts/allure-results
          allure_history: gh-pages-history/allure-history
          keep_reports: 20

      # 4. Organiza a pasta final que serÃ¡ publicada
      - name: Organize Reports
        run: |
          mkdir -p public/api-report
          mkdir -p public/mobile-report
          mkdir -p public/k6-report
          
          # Move Allure (que jÃ¡ foi gerado na pasta allure-history pelo plugin)
          cp -r allure-history public/
          # Cria um index na raiz redirecionando pro Allure (opcional, ou copia o conteudo)
          cp -r allure-history/* public/
          
          # Move API Report
          cp -r artifacts/api-report/* public/api-report/
          
          # Move Mobile Report
          cp -r artifacts/mobile-report/* public/mobile-report/
          
          # Move K6 Report
          cp -r artifacts/k6-report/* public/k6-report/

      # 5. Faz o Deploy de TUDO de uma vez
      - name: Deploy to Github Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: public
          force_orphan: true # Limpa o branch e sobe a versÃ£o nova limpa

      # 6. Links no Resumo
      - name: ðŸ“¢ Summary Links
        run: |
          echo "### ðŸ“Š Central de RelatÃ³rios QA" >> $GITHUB_STEP_SUMMARY
          echo "| Tipo de Teste | Status | Link |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ–¥ï¸ **E2E (Allure)** | âœ… Gerado | [Ver RelatÃ³rio](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¡ **API** | âœ… Gerado | [Ver RelatÃ³rio](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api-report/) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± **Mobile** | âœ… Gerado | [Ver RelatÃ³rio](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/mobile-report/) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ **Load (K6)** | âœ… Gerado | [Ver RelatÃ³rio](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/k6-report/) |" >> $GITHUB_STEP_SUMMARY