name: workflow-pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ==================================================================
  # PARTE 1: RODAR TESTES (PARALELO)
  # ==================================================================

  # 1. API TESTS (Gera Allure JSONs)
  api-tests:
    name: âš¡ API Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18, cache: 'npm' }
      - run: npm ci
      - run: npx playwright install --with-deps
      
      - name: Run API Tests
        run: npm run test:api
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}

      # Salva resultados para o Allure
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-api
          path: allure-results/
          retention-days: 1

  # 2. E2E TESTS (Gera Allure JSONs)
  e2e-tests:
    name: ðŸ–¥ï¸ E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v3
        with: { distribution: 'temurin', java-version: '17' }
      - uses: actions/setup-node@v4
        with: { node-version: 18, cache: 'npm' }
      - run: npm ci
      - run: npx playwright install --with-deps chromium
      
      - name: Run E2E Tests
        run: npm run test:e2e
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
          SAUCE_PASSWORD: ${{ secrets.SAUCE_PASSWORD }}
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-e2e
          path: allure-results/
          retention-days: 1

  # 3. MOBILE TESTS (Gera Allure JSONs)
  mobile-tests:
    name: ðŸ“± Mobile Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18, cache: 'npm' }
      - run: npm ci
      - run: npx playwright install --with-deps
      
      - name: Run Mobile Tests
        run: test:mobile
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-mobile
          path: allure-results/
          retention-days: 1

  # 4. VISUAL TESTS (NOVO - Gera Allure JSONs)
  visual-tests:
    name: ðŸŽ¨ Visual Regression
    runs-on: ubuntu-latest
    # Usa container oficial para garantir que as fontes (fonts) sejam iguais ao local
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18 }
      - run: npm ci
      # Nota: Container jÃ¡ vem com browsers instalados
      
      - name: Run Visual Tests
        run: npm run test:visual
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-visual
          path: allure-results/
          retention-days: 1

  # 5. LOAD TESTS (K6 separado)
  load-tests:
    name: ðŸš€ K6 Load
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18 }
      - run: npm ci
      - uses: grafana/setup-k6-action@v1
      
      - name: Run Load Tests
        run: |
          docker compose -f tests/k6-load/docker-compose.yml up -d influxdb grafana
          sleep 15
          npm run k6:ci
          docker compose -f tests/k6-load/docker-compose.yml down
        env:
          K6_BASE_URL: ${{ secrets.K6_BASE_URL }}

      - name: Move Report
        if: always()
        run: |
          mkdir -p k6-temp
          mv tests/k6-load/dist/report.html k6-temp/index.html || mv report.html k6-temp/index.html

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-report
          path: k6-temp/
          retention-days: 1

  # ==================================================================
  # PARTE 2: DEPLOY UNIFICADO
  # ==================================================================
  report-deploy:
    name: ðŸ“Š Publish Unified Report
    if: always()
    # Espera TODOS os testes acabarem
    needs: [api-tests, e2e-tests, mobile-tests, visual-tests, load-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get Allure history
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages-history

      # 1. Baixa TUDO (API, E2E, Mobile, Visual, K6)
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      # 2. Consolida os resultados do Allure (Junta os JSONs numa pasta sÃ³)
      - name: Merge Allure Results
        run: |
          mkdir -p allure-results
          # Copia resultados de todos os jobs para a pasta final
          cp artifacts/allure-api/* allure-results/ || true
          cp artifacts/allure-e2e/* allure-results/ || true
          cp artifacts/allure-mobile/* allure-results/ || true
          cp artifacts/allure-visual/* allure-results/ || true

      # 3. Gera UM relatÃ³rio Allure contendo TUDO
      - name: Generate Unified Allure Report
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: allure-results
          allure_history: gh-pages-history/allure-history
          keep_reports: 20

      # 4. Organiza pasta Public (Allure Unificado na raiz + K6 na subpasta)
      - name: Organize Reports
        run: |
          mkdir -p public/k6-report
          
          # Allure na Raiz (Copia do output gerado: allure-report)
          cp -r allure-report/* public/
          
          # K6 na subpasta
          cp -r artifacts/k6-report/* public/k6-report/

      # 5. Deploy para GitHub Pages
      - name: Deploy to Github Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: public
          force_orphan: true

      # 6. Tabela com Links no Resumo
      - name: ðŸ“¢ Summary Links
        run: |
          echo "### ðŸ“Š Central de RelatÃ³rios Unificada" >> $GITHUB_STEP_SUMMARY
          echo "| Tipo de Teste | Visualizar |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ… **QA Dashboard (E2E + API + Mobile + Visual)** | [**Ver Allure Report**](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ **Performance (K6)** | [**Ver K6 Dashboard**](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/k6-report/) |" >> $GITHUB_STEP_SUMMARY